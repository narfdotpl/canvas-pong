#!/usr/bin/env ruby

#---------
#  paths
#---------

require 'pathname'

def realpath(path)
  Pathname.new(__FILE__).dirname.realpath.join(path)
end

SOURCE_DIR = realpath('src')
BUILD_DIR = realpath('build')


#--------------
#  main tasks
#--------------

desc 'build production version'
task :build do
  dir
  html
  js
end

desc 'build development version'
task :dev do
  dir
  html_dev
  js_dev
end


#------------
#  subtasks
#------------

desc 'prepare empty build directory'
task :dir do
  system "[ ! -d #{BUILD_DIR} ] && mkdir #{BUILD_DIR}"
  system "rm -rf #{BUILD_DIR}/*"
end

desc 'render html'
task :html do
  system "haml #{SOURCE_DIR}/haml/pong.haml > #{BUILD_DIR}/index.html"
end

desc 'render development html'
task :html_dev do
  system "haml #{SOURCE_DIR}/haml/dev.haml > #{BUILD_DIR}/index.html"
end

desc 'copy jQuery'
task :jQuery do
  system "cp #{SOURCE_DIR}/jquery.min.js #{BUILD_DIR}"
end

desc 'compress js'
task :js do
  jQuery
  system "java -jar #{SOURCE_DIR}/compiler/compiler.jar " +
         "--compilation_level=SIMPLE_OPTIMIZATIONS " +
         "--js=#{SOURCE_DIR}/pong/init.js " +
         "--js=#{SOURCE_DIR}/pong/ball.js " +
         "--js=#{SOURCE_DIR}/pong/keys.js " +
         "--js=#{SOURCE_DIR}/pong/racket.js " +
         "--js=#{SOURCE_DIR}/pong/play.js " +
         "--js_output_file=#{BUILD_DIR}/pong.js"
end

desc 'symlink js files to build dir'
task :js_dev do
  jQuery
  system "ln -s #{SOURCE_DIR}/pong/*.js #{BUILD_DIR}"
end
